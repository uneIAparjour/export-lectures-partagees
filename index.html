<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Export des lectures partagées - Une IA par jour</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#2D2D2D;min-height:100vh;color:#E8E8E8}
    .container{max-width:600px;margin:0 auto}
    header{background:linear-gradient(135deg,#1a1a1a,#2D2D2D);color:#fff;padding:28px 24px;text-align:center;border-bottom:3px solid #E67E22}
    header h1{font-size:1.4rem;font-weight:700;margin-bottom:8px;color:#E67E22}
    header p{font-size:.9rem;opacity:.85;color:#B0B0B0}
    main{padding:20px}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
    .stat{background:#3D3D3D;border-radius:12px;padding:16px;text-align:center;border:1px solid #4D4D4D}
    .stat-value{font-size:1.6rem;font-weight:700}
    .stat-label{font-size:.75rem;color:#A0A0A0;margin-top:4px}
    .search-input{width:100%;padding:14px 16px;border:2px solid #4D4D4D;border-radius:12px;font-size:1rem;margin-bottom:16px;outline:0;background:#3D3D3D;color:#E8E8E8}
    .search-input::placeholder{color:#808080}
    .search-input:focus{border-color:#E67E22}
    .tabs{display:flex;gap:8px;margin-bottom:16px;background:#3D3D3D;padding:4px;border-radius:12px}
    .tab-btn{flex:1;padding:12px;border:0;border-radius:8px;background:0 0;color:#A0A0A0;font-weight:400;font-size:.9rem;cursor:pointer;transition:all .2s}
    .tab-btn.active{background:#E67E22;color:#fff;font-weight:600}
    .content-box{background:#3D3D3D;border-radius:16px;padding:16px;margin-bottom:20px;max-height:300px;overflow-y:auto;border:1px solid #4D4D4D}
    .cat-btn,.res-btn{display:flex;align-items:center;justify-content:space-between;width:100%;padding:12px 16px;margin-bottom:8px;border:2px solid #4D4D4D;border-radius:10px;background:#2D2D2D;cursor:pointer;text-align:left;transition:all .2s;color:#E8E8E8}
    .cat-btn:hover,.res-btn:hover{border-color:#5D5D5D}
    .check{width:20px;height:20px;border-radius:6px;background:#4D4D4D;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;flex-shrink:0}
    .action-btns{display:flex;gap:8px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #4D4D4D}
    .action-btn{flex:1;padding:8px;border:1px solid #4D4D4D;border-radius:8px;background:#2D2D2D;font-size:.8rem;cursor:pointer;color:#A0A0A0;transition:all .2s}
    .action-btn:hover{background:#4D4D4D;color:#E8E8E8}
    h4{margin:0 0 12px;font-size:.95rem;color:#E67E22}
    .formats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .fmt-btn{padding:16px 12px;border:2px solid #4D4D4D;border-radius:12px;background:#3D3D3D;cursor:pointer;text-align:left;transition:all .2s}
    .fmt-btn:hover{border-color:#E67E22;transform:translateY(-2px);background:#4D4D4D}
    .fmt-btn .name{font-weight:600;font-size:.95rem;color:#E8E8E8;margin-bottom:4px}
    .fmt-btn .desc{font-size:.75rem;color:#A0A0A0}
    footer{text-align:center;padding:20px;color:#808080;font-size:.8rem}
    footer a{color:#E67E22;text-decoration:none}
    footer a:hover{text-decoration:underline}
    .update-info{font-size:.7rem;color:#606060;margin-top:4px}
    ::-webkit-scrollbar{width:8px}
    ::-webkit-scrollbar-track{background:#2D2D2D;border-radius:4px}
    ::-webkit-scrollbar-thumb{background:#4D4D4D;border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:#5D5D5D}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Exporter les lectures partagées</h1>
    <p id="header-stats">Chargement...</p>
    <p class="update-info">Dernière mise à jour : 02/02/2026</p>
  </header>
  <main id="app"></main>
</div>
<script>

<script>
(function(){

/* ============================================================
   CONFIGURATION DES CATÉGORIES
   Chaque clé correspond à l'id du <h2> sur la page WordPress.
   - label : nom affiché dans l'interface
   - color : couleur du badge et de la sélection
   ============================================================ */
const CATEGORIES = {
  etudes:       { label: "Études et recherche",          color: "#3B82F6" },
  ethique:      { label: "Éthique et société",           color: "#A855F7" },
  travail:      { label: "IA et travail",                color: "#F59E0B" },
  securite:     { label: "Sécurité et désinformation",   color: "#EF4444" },
  creation:     { label: "Création, art et médias",      color: "#EC4899" },
  technique:    { label: "Technique et infrastructure",  color: "#10B981" },
  philosophie:  { label: "Philosophie et réflexions",    color: "#6366F1" },
  education:    { label: "Éducation",                    color: "#14B8A6" },
  droit:        { label: "Droit",                        color: "#F97316" },
  geopolitique: { label: "Géopolitique et international", color: "#06B6D4" }
};

/* ============================================================
   DONNÉES DES RESSOURCES
   Chargées depuis data.json (mis à jour par GitHub Actions).
   ============================================================ */
let RESOURCES = [];


/* ============================================================
   ÉTAT DE L'APPLICATION
   ============================================================ */

/* ============================================================
   ÉTAT DE L'APPLICATION
   ============================================================ */
let selectedCats = new Set();   // catégories cochées
let selectedRes = new Set();    // ressources cochées individuellement
let search = '';                // texte de recherche
let tab = 'categories';        // onglet actif : 'categories' ou 'resources'

/* ============================================================
   FONCTIONS UTILITAIRES
   ============================================================ */

/** Formate une date ISO en format français (JJ/MM/AAAA) */
const formatDate = (d) => new Date(d).toLocaleDateString('fr-FR');

/** Retourne les ressources filtrées par catégories et recherche */
const getFiltered = () => {
  let result = RESOURCES;
  if (selectedCats.size) result = result.filter(r => selectedCats.has(r.cat));
  if (search) {
    const query = search.toLowerCase();
    result = result.filter(r =>
      r.title.toLowerCase().includes(query) ||
      r.desc.toLowerCase().includes(query)
    );
  }
  return result.sort((a, b) => new Date(b.date) - new Date(a.date));
};

/** Retourne les ressources à exporter (sélection individuelle ou filtrées) */
const getExportable = () =>
  selectedRes.size ? RESOURCES.filter(r => selectedRes.has(r.id)) : getFiltered();

/** Regroupe un tableau de ressources par catégorie */
const groupByCategory = (resources) => {
  const grouped = {};
  resources.forEach(r => {
    if (!grouped[r.cat]) grouped[r.cat] = [];
    grouped[r.cat].push(r);
  });
  return grouped;
};

/* ============================================================
   GÉNÉRATEURS D'EXPORT (7 formats)
   ============================================================ */

function genOPML(resources) {
  const grouped = groupByCategory(resources);
  let output = `<?xml version="1.0" encoding="UTF-8"?>\n<opml version="2.0">\n<head><title>Lectures partagées - Une IA par jour</title><dateCreated>${new Date().toISOString()}</dateCreated></head>\n<body>`;
  Object.entries(grouped).forEach(([catKey, items]) => {
    output += `\n<outline text="${CATEGORIES[catKey]?.label}" title="${CATEGORIES[catKey]?.label}">`;
    items.forEach(r => {
      output += `\n<outline type="link" text="${r.title.replace(/"/g,'&quot;')}" url="${r.url}" created="${r.date}"/>`;
    });
    output += `\n</outline>`;
  });
  return output + `\n</body>\n</opml>`;
}

function genXML(resources) {
  let output = `<?xml version="1.0" encoding="UTF-8"?>\n<lecturesPartagees>\n<metadata><title>Lectures partagées</title><dateExport>${new Date().toISOString()}</dateExport><total>${resources.length}</total></metadata>\n<resources>`;
  resources.forEach(r => {
    output += `\n<resource id="${r.id}"><title><![CDATA[${r.title}]]></title><description><![CDATA[${r.desc}]]></description><url>${r.url}</url><date>${r.date}</date><letter>${r.letter}</letter><category>${CATEGORIES[r.cat]?.label}</category><source><![CDATA[${r.source}]]></source></resource>`;
  });
  return output + `\n</resources>\n</lecturesPartagees>`;
}

function genMarkdown(resources) {
  const grouped = groupByCategory(resources);
  let output = `# Lectures partagées - Une IA par jour\n\n> Export du ${formatDate(new Date())} — ${resources.length} ressources\n\n---\n\n`;
  Object.entries(grouped).forEach(([catKey, items]) => {
    output += `## ${CATEGORIES[catKey]?.label}\n\n`;
    items.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(r => {
      output += `### ${r.title}\n\n${r.desc}\n\n- **Date** : ${formatDate(r.date)}\n- **Lettre** : #${r.letter}\n- **Lien** : [${r.url}](${r.url})\n\n---\n\n`;
    });
  });
  return output;
}

function genBookmarks(resources) {
  const grouped = groupByCategory(resources);
  let output = `<!DOCTYPE NETSCAPE-Bookmark-file-1>\n<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">\n<TITLE>Lectures partagées</TITLE>\n<H1>Lectures partagées</H1>\n<DL><p>`;
  Object.entries(grouped).forEach(([catKey, items]) => {
    output += `\n<DT><H3>${CATEGORIES[catKey]?.label}</H3>\n<DL><p>`;
    items.forEach(r => {
      output += `\n<DT><A HREF="${r.url}" ADD_DATE="${Math.floor(new Date(r.date).getTime()/1000)}">${r.title}</A>`;
    });
    output += `\n</DL><p>`;
  });
  return output + `\n</DL><p>`;
}

function genBibTeX(resources) {
  let output = `% Lectures partagées - Une IA par jour\n% ${resources.length} ressources\n\n`;
  resources.forEach(r => {
    const key = r.title.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 15) + r.id;
    output += `@online{${key},\n  author = {${r.source.replace(/[{}]/g, '')}},\n  title = {${r.title.replace(/[{}]/g, '')}},\n  year = {${r.date.substring(0, 4)}},\n  url = {${r.url}},\n  keywords = {${r.cat}, ia}\n}\n\n`;
  });
  return output;
}

function genJSON(resources) {
  return JSON.stringify({
    metadata: {
      title: "Lectures partagées - Une IA par jour",
      exportDate: new Date().toISOString(),
      total: resources.length
    },
    resources: resources.map(r => ({
      id: r.id,
      title: r.title,
      description: r.desc,
      url: r.url,
      date: r.date,
      letter: r.letter,
      category: r.cat,
      categoryLabel: CATEGORIES[r.cat]?.label,
      source: r.source
    }))
  }, null, 2);
}

function genCSV(resources) {
  const escape = (s) => `"${String(s).replace(/"/g, '""')}"`;
  let output = 'ID;Titre;Description;URL;Date;Lettre;Catégorie;Source\n';
  resources.forEach(r => {
    output += `${r.id};${escape(r.title)};${escape(r.desc)};${escape(r.url)};${r.date};${r.letter};${escape(CATEGORIES[r.cat]?.label)};${escape(r.source)}\n`;
  });
  return output;
}

/* ============================================================
   TÉLÉCHARGEMENT ET EXPORT
   ============================================================ */

/** Déclenche le téléchargement d'un fichier généré */
function download(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/** Lance l'export dans le format demandé */
function exportFormat(format) {
  const data = getExportable();
  const formats = {
    opml:      [genOPML(data),      'lectures-partagees.opml',                'application/xml'],
    xml:       [genXML(data),       'lectures-partagees.xml',                 'application/xml'],
    markdown:  [genMarkdown(data),  'lectures-partagees.md',                  'text/markdown'],
    bookmarks: [genBookmarks(data), 'lectures-partagees-bookmarks.html',      'text/html'],
    bibtex:    [genBibTeX(data),    'lectures-partagees.bib',                 'application/x-bibtex'],
    json:      [genJSON(data),      'lectures-partagees.json',                'application/json'],
    csv:       [genCSV(data),       'lectures-partagees.csv',                 'text/csv']
  };
  if (formats[format]) download(...formats[format]);
}

/* ============================================================
   RENDU DE L'INTERFACE
   ============================================================ */

/** Génère le HTML de la liste des catégories */
function renderCategories() {
  return Object.entries(CATEGORIES).map(([key, { label, color }]) => {
    const count = RESOURCES.filter(r => r.cat === key).length;
    const selected = selectedCats.has(key);
    return `<button class="cat-btn" data-cat="${key}" style="border-color:${selected ? color : '#4D4D4D'};background:${selected ? color + '20' : '#2D2D2D'}">
      <div style="display:flex;align-items:center">
        <div class="check" style="background:${selected ? color : '#4D4D4D'};margin-right:12px">${selected ? '✓' : ''}</div>
        <span style="font-weight:${selected ? '600' : '400'};color:${selected ? color : '#E8E8E8'}">${label}</span>
      </div>
      <span style="background:${selected ? color : '#4D4D4D'};color:#fff;padding:4px 10px;border-radius:20px;font-size:.8rem;font-weight:600">${count}</span>
    </button>`;
  }).join('');
}

/** Génère le HTML de la liste des ressources filtrées */
function renderResources(filtered) {
  let html = `<div class="action-btns"><button class="action-btn" id="sel-all">Tout sélectionner</button><button class="action-btn" id="clr-all">Effacer</button></div>`;
  filtered.forEach(r => {
    const selected = selectedRes.has(r.id);
    const color = CATEGORIES[r.cat]?.color || '#6B7280';
    html += `<button class="res-btn" data-id="${r.id}" style="border-color:${selected ? color : '#4D4D4D'};background:${selected ? color + '15' : '#2D2D2D'};gap:12px">
      <div class="check" style="background:${selected ? color : '#4D4D4D'}">${selected ? '✓' : ''}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:500;font-size:.9rem;color:#E8E8E8;margin-bottom:4px;line-height:1.3">${r.title}</div>
        <div style="font-size:.75rem;color:#A0A0A0">
          <span style="display:inline-block;background:${color}30;color:${color};padding:2px 8px;border-radius:4px;font-weight:500;margin-right:8px">${CATEGORIES[r.cat]?.label}</span>#${r.letter} · ${formatDate(r.date)}
        </div>
      </div>
    </button>`;
  });
  return html;
}

/** Rendu principal : reconstruit toute l'interface */
function render() {
  const app = document.getElementById('app');
  const filtered = getFiltered();
  const exportable = getExportable();

  document.getElementById('header-stats').textContent =
    `${RESOURCES.length} ressources · 10 catégories · 7 formats`;

  app.innerHTML = `
    <div class="stats">
      <div class="stat"><div class="stat-value" style="color:#E67E22">${filtered.length}</div><div class="stat-label">Filtrées</div></div>
      <div class="stat"><div class="stat-value" style="color:#27AE60">${exportable.length}</div><div class="stat-label">À exporter</div></div>
      <div class="stat"><div class="stat-value" style="color:#9B59B6">${selectedCats.size || 10}</div><div class="stat-label">Catégories</div></div>
    </div>
    <input type="text" class="search-input" id="search" placeholder="Rechercher..." value="${search}">
    <div class="tabs">
      <button class="tab-btn ${tab === 'categories' ? 'active' : ''}" data-tab="categories">Par catégorie</button>
      <button class="tab-btn ${tab === 'resources' ? 'active' : ''}" data-tab="resources">Par article</button>
    </div>
    <div class="content-box">${tab === 'categories' ? renderCategories() : renderResources(filtered)}</div>
    <h4>Choisir un format</h4>
    <div class="formats">
      <button class="fmt-btn" data-fmt="opml"><div class="name">OPML</div><div class="desc">Feedly, Inoreader...</div></button>
      <button class="fmt-btn" data-fmt="xml"><div class="name">XML</div><div class="desc">Format structuré</div></button>
      <button class="fmt-btn" data-fmt="markdown"><div class="name">Markdown</div><div class="desc">Documentation</div></button>
      <button class="fmt-btn" data-fmt="bookmarks"><div class="name">Bookmarks</div><div class="desc">Navigateurs</div></button>
      <button class="fmt-btn" data-fmt="bibtex"><div class="name">BibTeX</div><div class="desc">Zotero, Mendeley...</div></button>
      <button class="fmt-btn" data-fmt="json"><div class="name">JSON</div><div class="desc">Développeurs</div></button>
      <button class="fmt-btn" data-fmt="csv"><div class="name">CSV</div><div class="desc">Tableurs</div></button>
    </div>
    <footer>
      <a href="https://www.uneiaparjour.fr/" target="_blank">Une IA par jour</a>
      <p><a href="https://github.com/uneIAparjour/export-lectures-partagees" target="_blank">Dépôt Github</a></p>
    </footer>`;

  /* --- Événements --- */
  document.getElementById('search').addEventListener('input', (e) => {
    search = e.target.value;
    render();
    document.getElementById('search').focus();
  });

  document.querySelectorAll('.tab-btn').forEach(btn =>
    btn.addEventListener('click', () => { tab = btn.dataset.tab; render(); })
  );

  document.querySelectorAll('.cat-btn').forEach(btn =>
    btn.addEventListener('click', () => {
      const cat = btn.dataset.cat;
      selectedCats.has(cat) ? selectedCats.delete(cat) : selectedCats.add(cat);
      render();
    })
  );

  document.querySelectorAll('.res-btn').forEach(btn =>
    btn.addEventListener('click', () => {
      const id = parseInt(btn.dataset.id);
      selectedRes.has(id) ? selectedRes.delete(id) : selectedRes.add(id);
      render();
    })
  );

  document.getElementById('sel-all')?.addEventListener('click', () => {
    filtered.forEach(r => selectedRes.add(r.id));
    render();
  });

  document.getElementById('clr-all')?.addEventListener('click', () => {
    selectedRes.clear();
    selectedCats.clear();
    render();
  });

  document.querySelectorAll('.fmt-btn').forEach(btn =>
    btn.addEventListener('click', () => exportFormat(btn.dataset.fmt))
  );
}

/* Chargement des données et lancement */
fetch('data.json')
  .then(response => {
    if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
    return response.json();
  })
  .then(data => {
    RESOURCES = data;
    render();
  })
  .catch(error => {
    console.error('Erreur de chargement des données:', error);
    document.getElementById('app').innerHTML =
      '<p style="color:#EF4444;text-align:center;padding:40px">Erreur de chargement des données.<br>Veuillez rafraîchir la page.</p>';
  });

})();
</script>
</body>
</html>
